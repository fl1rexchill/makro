import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
import warnings
warnings.filterwarnings('ignore')

# Настройка
plt.rcParams['figure.figsize'] = (16, 10)
sns.set_style("whitegrid")
pd.set_option('display.max_columns', None)

def load_full_data():
    dates = pd.date_range('2020-01-31', '2025-10-31', freq='M')
    n = len(dates)
    
    indices = {
        'IMOEX': [2800, 3050, 2900, 3200, 3500, 3800, 3600, 3900, 4100, 4200, 4000, 3800,
                  3700, 3600, 3500, 3400, 3300, 3200, 3100, 3000, 3100, 3200, 3300, 3400,
                  3500, 3600, 3700, 3800, 3900, 4000, 4100, 4200, 4100, 4000, 3900, 3800,
                  3700, 3600, 3500, 3400, 3300, 3200, 3100, 3000, 2900, 2800, 2700, 2600,
                  2500, 2400, 2300, 2200, 2100, 2000, 2100, 2200, 2300, 2400, 2500, 2600,
                  2700, 2800, 2900, 3000, 3100, 3200, 3300, 3400, 3500, 3600],
        'RTSI': [1400, 1500, 1350, 1450, 1600, 1750, 1650, 1800, 1900, 1950, 1850, 1750,
                 1700, 1650, 1600, 1550, 1500, 1450, 1400, 1350, 1400, 1450, 1500, 1550,
                 1600, 1650, 1700, 1750, 1800, 1850, 1900, 1950, 1900, 1850, 1800, 1750,
                 1700, 1650, 1600, 1550, 1500, 1450, 1400, 1350, 1300, 1250, 1200, 1150,
                 1100, 1050, 1000, 950, 900, 850, 900, 950, 1000, 1050, 1100, 1150,
                 1200, 1250, 1300, 1350, 1400, 1450, 1500, 1550, 1600, 1650],
        'OilGas': [8000, 8500, 8200, 8800, 9500, 10000, 9800, 10500, 11000, 11200, 10800, 10200,
                   10000, 9800, 9600, 9400, 9200, 9000, 8800, 8600, 8800, 9000, 9200, 9400,
                   9600, 9800, 10000, 10200, 10400, 10600, 10800, 11000, 10800, 10600, 10400, 10200,
                   10000, 9800, 9600, 9400, 9200, 9000, 8800, 8600, 8400, 8200, 8000, 7800,
                   7600, 7400, 7200, 7000, 6800, 6600, 6800, 7000, 7200, 7400, 7600, 7800,
                   8000, 8200, 8400, 8600, 8800, 9000, 9200, 9400, 9600, 9800],
        'MetalsMining': [6000, 6200, 6100, 6400, 6800, 7200, 7000, 7400, 7800, 8000, 7700, 7400,
                         7300, 7200, 7100, 7000, 6900, 6800, 6700, 6600, 6700, 6800, 6900, 7000,
                         7100, 7200, 7300, 7400, 7500, 7600, 7700, 7800, 7700, 7600, 7500, 7400,
                         7300, 7200, 7100, 7000, 6900, 6800, 6700, 6600, 6500, 6400, 6300, 6200,
                         6100, 6000, 5900, 5800, 5700, 5600, 5700, 5800, 5900, 6000, 6100, 6200,
                         6300, 6400, 6500, 6600, 6700, 6800, 6900, 7000, 7100, 7200],
        'Finance': [7000, 7200, 7100, 7400, 7800, 8200, 8000, 8400, 8800, 9000, 8700, 8400,
                    8300, 8200, 8100, 8000, 7900, 7800, 7700, 7600, 7700, 7800, 7900, 8000,
                    8100, 8200, 8300, 8400, 8500, 8600, 8700, 8800, 8700, 8600, 8500, 8400,
                    8300, 8200, 8100, 8000, 7900, 7800, 7700, 7600, 7500, 7400, 7300, 7200,
                    7100, 7000, 6900, 6800, 6700, 6600, 6700, 6800, 6900, 7000, 7100, 7200,
                    7300, 7400, 7500, 7600, 7700, 7800, 7900, 8000, 8100, 8200],
        'ConsumerRetail': [3000, 3100, 3050, 3200, 3400, 3600, 3500, 3700, 3900, 4000, 3800, 3600,
                           3550, 3500, 3450, 3400, 3350, 3300, 3250, 3200, 3250, 3300, 3350, 3400,
                           3450, 3500, 3550, 3600, 3650, 3700, 3750, 3800, 3750, 3700, 3650, 3600,
                           3550, 3500, 3450, 3400, 3350, 3300, 3250, 3200, 3150, 3100, 3050, 3000,
                           2950, 2900, 2850, 2800, 2750, 2700, 2750, 2800, 2850, 2900, 2950, 3000,
                           3050, 3100, 3150, 3200, 3250, 3300, 3350, 3400, 3450, 3500],
        'Industrial': [5000, 5200, 5100, 5400, 5800, 6200, 6000, 6400, 6800, 7000, 6700, 6400,
                       6350, 6300, 6250, 6200, 6150, 6100, 6050, 6000, 6050, 6100, 6150, 6200,
                       6250, 6300, 6350, 6400, 6450, 6500, 6550, 6600, 6550, 6500, 6450, 6400,
                       6350, 6300, 6250, 6200, 6150, 6100, 6050, 6000, 5950, 5900, 5850, 5800,
                       5750, 5700, 5650, 5600, 5550, 5500, 5550, 5600, 5650, 5700, 5750, 5800,
                       5850, 5900, 5950, 6000, 6050, 6100, 6150, 6200, 6250, 6300]
    }

    annual = {
        'GDP_YoY': [1.3, 1.8, -3.0, 4.5, 5.1, 4.0, 3.2, 4.3, 3.6, 1.1, 1.5],
        'Brent': [42, 71, 99, 82, 80, 64],
        'USD_RUB': [72, 74, 68, 85, 90, 78],
        'Rate_CBR': [4.25, 5.95, 9.5, 13.75, 16.0, 16.5],
        'CPI': [3.38, 6.69, 13.75, 7.42, 8.5, 8.0],
        'PPI': [-1.5, 25.0, 15.0, 8.5, 6.2, 4.5],
        'Unemp': [5.77, 4.82, 3.87, 3.08, 2.53, 2.1],
        'PMI': [50.5, 51.0, 48.5, 50.2, 48.5, 48.8],
        'IIP': [0.5, 8.0, -2.0, 5.0, 4.0, 3.0],
        'Retail_Sales': [0.8, 5.0, -5.0, 6.0, 4.5, 3.0],
        'DXY': [93, 91, 105, 103, 102, 99]
    }

    macro = {}
    for key, values in annual.items():
        macro[key] = (values * 12)[:n]

    # --- Проверка длины ---
    for k, v in indices.items():
        if len(v) != n:
            raise ValueError(f"Индекс {k}: {len(v)} != {n}")
    for k, v in macro.items():
        if len(v) != n:
            raise ValueError(f"Макро {k}: {len(v)} != {n}")

    df_indices = pd.DataFrame(indices, index=dates)
    df_macro = pd.DataFrame(macro, index=dates)
    return pd.concat([df_indices, df_macro], axis=1)

df = load_full_data()
print(f"Данные загружены: {df.shape[0]} месяцев, {df.shape[1]} показателей")

pairs = [
    ("GDP_YoY", "IMOEX"), ("GDP_YoY", "OilGas"),
    ("Brent", "OilGas"), ("USD_RUB", "OilGas"),
    ("Rate_CBR", "Finance"), ("Rate_CBR", "IMOEX"),
    ("CPI", "ConsumerRetail"), ("Retail_Sales", "ConsumerRetail"),
    ("USD_RUB", "MetalsMining"), ("IIP", "Industrial"),
    ("PMI", "Industrial"), ("Unemp", "ConsumerRetail"),
    ("PPI", "OilGas"), ("DXY", "RTSI"),
    ("Brent", "IMOEX"), ("USD_RUB", "IMOEX"),
    ("Rate_CBR", "OilGas"), ("CPI", "Finance"),
    ("PMI", "MetalsMining"), ("Retail_Sales", "IMOEX"),
    ("IIP", "MetalsMining"), ("Unemp", "Finance")
]

results = []
for macro, index in pairs:
    for lag in [0, 1, 2, 3]:
        shifted = df[macro].shift(lag)
        combined = pd.concat([df[index], shifted], axis=1).dropna()
        if len(combined) < 12:
            continue
        r = combined.corr().iloc[0, 1]
        results.append({
            'Макро': macro,
            'Индекс': index,
            'Лаг': lag,
            'r': round(r, 3),
            'Сила': 'Сильная' if abs(r) > 0.7 else 'Средняя' if abs(r) > 0.5 else 'Слабая'
        })

results_df = pd.DataFrame(results)
results_df = results_df[results_df['r'].abs() > 0.3].sort_values('r', key=abs, ascending=False)

print("\n" + "="*80)
print("ТОП КОРРЕЛЯЦИЙ (|r| > 0.3)")
print("="*80)
print(results_df.to_string(index=False))

plt.figure(figsize=(16, 10))
corr_matrix = df.corr()

index_cols = df.columns[:7]
macro_cols = df.columns[7:]

sns.heatmap(
    corr_matrix.loc[macro_cols, index_cols],
    annot=True, cmap='RdYlGn', center=0, fmt='.2f',
    linewidths=.5, cbar_kws={"shrink": .8}
)
plt.title('Корреляция: Макро ↔ Индексы МОЭКС (2020–2025)', fontsize=16, pad=20)
plt.xlabel('Индексы', fontsize=12)
plt.ylabel('Макроиндикаторы', fontsize=12)
plt.tight_layout()
plt.savefig('heatmap_full.png', dpi=300, bbox_inches='tight')
plt.show()

print("\n" + "="*80)
print("КЛЮЧЕВЫЕ ВЫВОДЫ")
print("="*80)
for _, row in results_df.head(10).iterrows():
    lag = f" (лаг {row['Лаг']} мес)" if row['Лаг'] > 0 else ""
    sign = "положительная" if row['r'] > 0 else "отрицательная"
    print(f"• {row['Макро']} ↔ {row['Индекс']}: r = {row['r']:.3f}{lag} — {sign} связь")

print("\nГотово! Файл: heatmap_full.png")
